---

- name: install required packages
  ansible.builtin.apt:
    state: present
    name:
      - openssh-client
      - openssh-server
      - sshfs
      - sshuttle

- name: add core_user ssh keys
  ansible.posix.authorized_key:
    user: "{{ core_user }}"
    key: |
      {% for pubkey in core_user_ssh_keys %}
      {{ pubkey }}
      {% endfor %}
    exclusive: true

- name: secure sshd
  ansible.builtin.template:
    src: ssh/sshd_config
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0600"
    validate: "/usr/sbin/sshd -t -f %s"
  notify: reload sshd

- name: rm /etc/ssh/sshd_config.d/50-cloud-init.conf
  ansible.builtin.file:
    path: /etc/ssh/sshd_config.d/50-cloud-init.conf
    state: absent

- name: set ssh default
  ansible.builtin.template:
    src: ssh/ssh_config
    dest: /etc/ssh/ssh_config
    owner: root
    group: root
    mode: "0644"
